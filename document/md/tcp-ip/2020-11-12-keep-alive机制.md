
### TCP Keep-alive机制

| 作者 | 时间 |QQ技术交流群 |
| ------ | ------ |------ |
| perrynzhou@gmail.com |2020/11/12 |中国开源存储技术交流群(672152841) |

- TCP需要保活跃背景是这样，设想这种情况，TCP连接建立后，在一段时间范围内双发没有互相发送任何数据。思考以下两个问题：
	- 怎么判断对方是否还在线。这是因为，TCP对于非正常断开的连接系统并不能侦测到（比如网线断掉）。
	- 长时间没有任何数据发送，连接可能会被中断。这是因为，网络连接中间可能会经过路由器、防火墙等设备，而这些有可能会对长时间没有活动的连接断掉。
- TCP确实有一种名为保持活跃(keep alive)机制来检测死了解，但是这对应用程序来说通常没有什么好处。应用程序自动保持活跃机制时,TCP会连接空闲一段时间间隔之后，向对等实体发送一个特殊的段，如果对等主机保持活跃可达，且对等应用程序仍然在运行，对等实体的TCP就会以ACK响应；如果对等实体不可到达,对等实体的TCP会以RST响应,TCP发送的保持活跃信号会丢弃连接，并向应用程序返回一个ECONNRESET错误。
- 对需要连接丢失即时通知的应用程序来说，保持活跃带来的第一个问题就是涉及的时间间隔,如果TCP实现了保活跃机制，在它开始发送保持活跃探测之前，必须有至少2个小时的默认空闲时间。
- Linux 保活机制是由一个保活计时器实现的。当计时器被激发，连接一段将发送一个保活探测报文，另一端接收报文的同时会发送一个`ACK`作为响应。下面是linux 保活机制的三个参数:保活时间、保活时间间隔、保活探测数。
  ```
  root@172.25.78.25 ~ $ cd /proc/sys/net/ipv4
  root@172.25.78.25 /proc/sys/net/ipv4 $ cat tcp_keepalive_time   
  30
  root@172.25.78.25 /proc/sys/net/ipv4 $ cat tcp_keepalive_intvl  
  75
  root@172.25.78.25 /proc/sys/net/ipv4 $ cat tcp_keepalive_probes 
  9
  ```
- 协议是如何工作的,大多数网络编程问题与程序编写和API无关，而是由于缺乏底层网络协议理解造成的。