# TCP超时和重传


| 作者 | 时间 |QQ技术交流群 |
| ------ | ------ |------ |
| perrynzhou@gmail.com |2020/11/23 |中国开源存储技术交流群(672152841) |



- 如何判断TCP丢包？
  - 由于网络层(IP层)可能出现丢包、乱序、重复的情况，为了保证TCP提供可靠的传输协议，TCP重传其认为已经丢失的包。TCP根据接收端返回给发送端一些列的确认信息来判断是否丢包
- 有哪几种重传的形态？
  - 当数据段或者确认信息丢失，TCP启动重传操作，重传尚未确认的数据。TCP提供两种独立机制来完成重传，一种基于时间的，一种基于确认信息的构成。
- 基于时间和确认信息的重传怎么理解?
  - 基于时间的重传，又称为基于计时器的重传，TCP在发送数据时候回设计一个计时器，如果计时器超时还没有收到数据确认信息，则会引发响应的超时或者基于时间的计时器的重传，计时器的超时称为重传超时(RTO)。
  - 基于确认信息的重传，这个又称为快速重传，通常发生在没有延迟的情况下。如果TCP累计确认无法返回新的ACK（重复)，或者当ACK包含的选择确认信息(SACK)表明出现失序报文段(乱序)时，快速重传会认为丢包了,快速重传会启动，重传认为已经丢掉的包。
- 怎么根据RTT设置RTO?
  - 有两种情况会造成不良的后果，第一种TCP先于RTT开始重传，这样会造成网络中大量的重复报；第二种，TCP传输时间点延迟至RTT的时间间隔发送重传数据，会造成网络的整理利用率低。所以TCP在收到数据后返回确认信息(ACK)，在ACK中中携带一个字节的数据来测量传输该ACK所需要的时间，这个称谓RTT样本，TCP首先根据一段时间内的样本值建立好估计值，基于和这个估计值来作为根据RTT设置RTO的基础
  - 每个TCP连接的RTT均独立计算，并且重传计时器会对任何占用序列号的在传数据(包括SYN和FIN报文段)计时。计算RTT有两种方法，一种是经典方法，另外一种是标准方法。对于相对比较稳定的RTT的环境下，标准方法能获取不错的性能。但是在RTT在变化较大的网络中，无法获取期望的效果。
    
    ```
    //经典方法,a为平滑因子，SRTT是先的RTT的值,RTT是新的样本值
    SRTT= a(SRTT)+(1-a)RTT
    //ubound是RTO的上边界，可设定建议值；lbound为下边界，X为延迟离散因子
    RTO=min(ubound,max(lbound,X(SRTT)))

    //标准方法
    ```
- 什么是重传二义性？怎么理解karn算法？
  - 二义性，假设一个包的传输出现超时，该数据包会被重传，接着收到一个ACK确认信息，那么该信息是对第一次还是第二次传输的确认就存在二义性。
  - karn算法分为两个部分，第一个部分是当超时重传，接收到重传数据的ACK信息时不能更新RTT的估计值。第二部分，超时重传过程中退避系数加倍,TCP在计算RTO过程中采用退避系数，每当重传计时器出现超时，退避系数会加倍，这过程一直持续到接受端收到非重传数据，此时退避系数重设为1(二进制指数退避取消)，重传计时器返回正常值。退避系数表现在当发生超时重传时候，同一个包接受端没有接受到，这个包的发送时间间隔是上一次发送时间的1倍，比如1s、2s、4s、8s这样

- 带时间戳选项的RTT测量
  - 时间戳值(TSV)携带于初始化SYN的TSOPT中，并在SYN+ACK的TSOPT的USER部分返回，此时设定srtt、rttvar和RTO初始化值。
  - TCP并非对其连接收到的每个报文都返回ACK,当传输大量数据时候,TCP通常采用每2个报文返回一个ACK的方式。
- 当发生超时重传会发生什么?
  - TCP将超时重传认为相当重要的事情，当这种情况发生时候，TCP通过降低当前的发送速率来快速响应。减低发送速率有两种方法，第一是基于拥塞控制机制来减少发送窗口的大小；第二是每当一个重传报文段再次被重传时候，则增大RTO的退避因子，这是就是karn算法的第二部分。

- 快速重传原理是什么?
  - 快速重传是基于阶段端的反馈信息来出发重传，而非重传计时器的超时，当接收端收到失序的报文段时候，TCP需要立即生成确认信息(重复ACK),并且失序情况表明在后续数据包数据到达之前出现丢段，即接收端缓存出现了空缺，发送端的工作即为尽快的、高效的填补空缺。
  - 当失序数据达到时候，重复ACK立即返回，不能延时发送，原因在于使发送端尽快得知接收端的失序报文，并告诉其空缺位置。重复ACK到达发送端表明先前发送的某个分组丢失,重复ACK另外一情况是当网络出现大量失序分组时候，如果接受端收到当前期盼序列号的后续分组时，当前期盼的包可能丢失，也有可能仅为延迟到达，我们无法找到具体是一种情况发生了。此时TCP等待一定数目的重复ACK（重复ACK的阈值,dupthresh)来决定数据是否丢失并触发快速重传。
  - 快速重传的算法过程：TCP发送端在观测到至少dupthresh个重复ACK,即重传可能丢失的数据分组，而不必等到重传计时器的超时。当然也可以同时发送新数据，根据重复ACK推断的丢包通常与网络拥塞有关，因此伴随快速重传应该触发拥塞控制机制。若不采用SACK，接收端收到有效ACK前至多能重传一个报文段，采用SACK，ack可以包含额外信息，使得发送端在每个RTT时间内可以填补多个接收端的空缺。