
## TCP选项和路径MTU
| 作者 | 时间 |QQ技术交流群 |
| ------ | ------ |------ |
| perrynzhou@gmail.com |2020/11/23 |中国开源存储技术交流群(672152841) |


### TCP选项

- TCP最大段选项（MSS）
    - 最大段是指TCP协议允许的从对方收到的最大报文段，因此这也是通信对方在发送数据时候能够使用的最大报文段，最大段大小之记录在TCP的数据的字节数而不包括其他相关TCP和IP的头部
    - 当建立伊特TCP连接时，通信每一方都要在SYN报文段的MSS选项中说明自己允许的最大段大小，表示该最大段大小的长度为16位，所以在没说明情况下默认值为536个字节
    - 最大段大小并不是TCP通信双方协商的结果，而是一个固定的数值

- 选择确认选项（SACK）
    - 由于接受到的数据是无序的，所以接受到数据的序列号也是不连续的，在这样的情况下，TCP接受方的数据队列中会出现空洞情况，因此在提供字节流服务时，TCP接受方需要防止应用程序使用超出空洞的数据
    - 如果TCP发送方能够了解接受方当前的空洞以及在序列空间中超出空洞的乱序数据快，发送方能在报文段丢失或者被接受方遗漏时更好的进行重传工作，能够完成这个功能的只有SACK（选择确认选项)
    - 当接受SYN或者SYN+ACK的报文段中“允许选择确认”选项，TCP通信会了解到自身具有发布SACK信息的能力，当接受乱序数据时，它就能够提供一个SACK选项来描述这些乱序数据，从而帮助对方有效的进行重传
    - SACK信息保存于SACK选项中，它包含了接受方已经成功接受的数据快的序列号范围，每一个范围称为SACK块，是由一对32位的序列号表示。每个TCP头部选项空间有限，支持的最大的SACK块数目为3

- 窗口缩放选项
    - 窗口缩放选项能够有效的将TCP窗口广告大小的范围从16位增加到30位，TCP头部不需要改变窗口广告这个字段大小，仍然维持16位数值,同时使用另外一个选项作为这16位数值的比例因子，该比例因子能够使窗口字段有效的左移
    - 该窗口缩放选项只能出现与一个SYN报文段中，因此当连接建立以后比例因子是与方向绑定的，为了保证窗口调整，通信双方都需要在SYN报文段中包含该选项
    - 窗口的移动数值是由TCP通信方根据接受缓存大小自动选取的，缓存大小是由系统设定的，但是应用程序通常都具有改变其大小能力。
    - 当TCP协议用于大宽带/高延迟网络（往返时间和带宽相对较大的网络）上提供海量数据传输服务时候，窗口缩放选项的价值和意义非常大
- 时间戳选项
    - 时间戳选项（TSopt)要求发送方在每一个报文段中添加2个4字节的时间戳，接受方将会确认中反映这些时间戳，允许发送方针对每一个接受到的ACK估算TCP连接的往返时间（由于TCP协议经常利用一个ACK来确认多个报文段，此处需要说明每个接受到的ACK而不是每个报文)
    - 估算一条TCP连接往返时间主要为了设置重传超时，重传超时用于告知TCP通信方何时应该重新发送可能已经丢失的报文段
- 用户超时选项
    - 用户超时选项（UTO）是一个相对较新的TCP功能选项，用户超时指明了TCP发送者在确认对方未能成功接受数据之前愿意等待该数据ACK确认的时间

### TCP路径最大传输单元发现

- 路径最大传输单元(MTU)
    - 经过两台主机之间路径的所有报文段最大传输单元的最小值，称为路径最大传输单元
    - TCP常规的路径最大传输单元的过程如下：在一个连接建立时，TCP使用对外接口的最大传输单元最小值，或者根据通信对方声明的最大段大小来选择发送方的最大段大小（SMSS).路径最大传输单元发现不允许TCP发送方有超过另外一方所声明的最大段大小的情况。如果对方没有指明最大段大小的值，发送方将假设默认采用536个字节
    - 路径MTU发现过程是一种TCP明确调整段大小的方法，适合用于TCP连接建立以后，至少是传输大量数据时